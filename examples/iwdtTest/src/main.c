/**
 ****************************************************************************************
 *
 * @file main.c
 *
 * @brief 应用程序主入口 - 独立看门狗示例
 *
 * @details
 * 本示例演示独立看门狗(IWDG)的基本使用方法：
 * - 配置IWDT为中断模式，1秒超时
 * - 在中断服务函数中定期喂狗
 * - 监控中断次数并输出调试信息
 *
 * 工作原理：
 * 1. 初始化：配置IWDT控制寄存器，设置中断和复位使能
 * 2. 中断触发：IWDT计数器递减到0时产生中断
 * 3. 喂狗操作：在中断中重新加载计数器，避免系统复位
 * 4. 状态监控：记录中断次数并在主循环中显示
 *
 * 关键寄存器：
 * - IWDT_LOAD: 计数器重载值寄存器
 * - IWDT_CTRL: 控制寄存器（使能、中断、复位、时钟选择）
 * - IWDT_RIS:  中断标志寄存器
 * - IWDT_INICLR: 中断标志清除寄存器
 *
 ****************************************************************************************
 */

#include "b6x.h"
#include "drvs.h"
#include "dbg.h"


/*
 * DEFINES
 ****************************************************************************************
 */

#define IWDT_WINDOW        (32768)  ///< 看门狗超时窗口值 - 32.768KHz时钟下1秒超时


/*
 * FUNCTIONS
 ****************************************************************************************
 */

volatile bool irq_evt = false;  ///< 中断事件标志 - 用于主循环处理
volatile uint16_t irq_cnt = 0;  ///< 中断计数器 - 记录喂狗次数

/**
 ****************************************************************************************
 * @brief 独立看门狗中断服务函数
 *
 * @details
 * 当IWDT计数器递减到0时触发中断，在此函数中：
 * - 重新加载计数器值（喂狗）
 * - 设置中断事件标志
 * - 更新中断计数器
 *
 * 寄存器操作说明：
 * - iwdt_feed(): 写入IWDT_LOAD寄存器重新加载计数器
 * - 中断标志由硬件自动清除或通过IWDT_INICLR寄存器清除
 ****************************************************************************************
 */
void IWDT_IRQHandler(void)
{
    iwdt_feed();      ///< 喂狗操作 - 重新加载IWDT_LOAD寄存器
    irq_evt = true;   ///< 设置中断事件标志
    irq_cnt++;        ///< 更新中断计数器
}

/**
 ****************************************************************************************
 * @brief 独立看门狗初始化函数
 *
 * @details
 * 配置IWDT模块的完整流程：
 * 1. 初始化控制寄存器：使能IWDT、中断、复位，选择LSI时钟
 * 2. 设置重载值：配置超时时间
 * 3. 使能NVIC中断：允许IWDT中断触发
 *
 * 控制寄存器位说明：
 * - IWDT_EN_BIT:    使能独立看门狗
 * - IWDT_INTEN_BIT: 使能中断功能
 * - IWDT_RSTEN_BIT: 使能复位功能  
 * - IWDT_CLKLSI_BIT: 选择LSI(32KHz)时钟源
 ****************************************************************************************
 */
static void iwdtInit(void)
{
    /**
     * @brief 初始化IWDT控制寄存器
     * 
     * 使用默认配置(IWDT_CR_DFLT)并添加中断使能：
     * - IWDT_CR_DFLT = IWDT_EN_BIT | IWDT_RSTEN_BIT | IWDT_CLKLSI_BIT
     * - 添加IWDT_INTEN_BIT使能中断
     */
    iwdt_init(IWDT_INTEN_BIT | IWDT_CR_DFLT);
    
    /**
     * @brief 配置IWDT重载值
     * 
     * 设置IWDT_WINDOW(32768)作为计数器重载值：
     * - 使用32.768KHz LSI时钟
     * - 超时时间 = 32768 / 32768 = 1秒
     */
    iwdt_conf(IWDT_WINDOW);
    
    /**
     * @brief 配置NVIC中断
     * 
     * 使能IWDT中断向量，允许看门狗中断触发
     */
    NVIC_EnableIRQ(IWDT_IRQn);  ///< 使能IWDT中断
    __enable_irq();             ///< 使能全局中断
}

/**
 ****************************************************************************************
 * @brief 系统初始化函数
 *
 * @details
 * 配置系统基础设置，可根据需要添加时钟等配置
 ****************************************************************************************
 */
static void sysInit(void)
{
    // Todo config, if need - 可在此添加系统时钟等配置
}

/**
 ****************************************************************************************
 * @brief 设备初始化函数
 *
 * @details
 * 初始化外设模块：
 * - 读取复位原因
 * - 初始化调试接口
 * - 输出启动信息
 * - 初始化独立看门狗
 ****************************************************************************************
 */
static void devInit(void)
{
    uint16_t rsn = rstrsn();  ///< 读取复位原因寄存器
    
    dbgInit();  ///< 初始化调试接口

    /**
     * @brief 输出启动信息
     * 
     * 显示复位原因，帮助调试系统启动问题
     * 复位原因可能包括：上电复位、看门狗复位、软件复位等
     */
    debug("Start(rsn:0x%X)...\r\n", rsn);
    
    iwdtInit();  ///< 初始化独立看门狗
}

/**
 ****************************************************************************************
 * @brief 主函数
 *
 * @return int 程序退出状态
 *
 * @details
 * 程序执行主流程：
 * 系统初始化 → 设备初始化 → 主循环处理
 * 
 * 主循环功能：
 * - 检查看门狗中断事件标志
 * - 输出喂狗次数信息
 * - 保持系统正常运行
 ****************************************************************************************
 */
int main(void)
{
    sysInit();    ///< 系统初始化
    devInit();    ///< 设备初始化
    
    /**
     * @brief 主循环 - 监控看门狗状态
     * 
     * 持续检查中断事件标志，当有看门狗中断发生时输出调试信息
     * 通过irq_evt标志实现中断服务函数与主循环的通信
     */
    while (1)
    {
        if (irq_evt)  ///< 检查是否有看门狗中断发生
        {
            irq_evt = false;  ///< 清除中断事件标志
            
            /**
             * @brief 输出看门狗中断信息
             * 
             * 显示当前喂狗次数，验证看门狗正常工作
             * 正常情况下应每秒输出一次递增的计数值
             */
            debug("iwdt irq:%d\r\n", irq_cnt);
        }
    }
}
